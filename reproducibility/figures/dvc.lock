schema: '2.0'
stages:
  data_download_pancreas:
    cmd: python data_download.py data_external.sources=[scvelo] data_external.scvelo.download=[pancreas]
    deps:
    - path: data_download.py
      md5: 391e26ebb263cd5e550f9365c4a7f21f
      size: 2881
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.scvelo.pancreas:
          data_file: endocrinogenesis_day15.h5ad
          dl_root: data/Pancreas
          dl_path: data/Pancreas/endocrinogenesis_day15.h5ad
          rel_path: data/external/endocrinogenesis_day15.h5ad
          url: https://github.com/theislab/scvelo_notebooks/raw/master/data/Pancreas/endocrinogenesis_day15.h5ad
          derived:
            process_method: load_data
            rel_path: data/processed/pancreas_processed.h5ad
    outs:
    - path: data/external/endocrinogenesis_day15.h5ad
      md5: 783ec70c72fd895eeea28c07735efc27
      size: 52477898
  preprocess_pancreas:
    cmd: python preprocess.py data_external.sources=[scvelo] data_external.scvelo.process=[pancreas]
    deps:
    - path: data/external/endocrinogenesis_day15.h5ad
      md5: 783ec70c72fd895eeea28c07735efc27
      size: 52477898
    - path: preprocess.py
      md5: 346eaf42eb0c6c729be1bfc60148787c
      size: 2451
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.scvelo.pancreas:
          data_file: endocrinogenesis_day15.h5ad
          dl_root: data/Pancreas
          dl_path: data/Pancreas/endocrinogenesis_day15.h5ad
          rel_path: data/external/endocrinogenesis_day15.h5ad
          url: https://github.com/theislab/scvelo_notebooks/raw/master/data/Pancreas/endocrinogenesis_day15.h5ad
          derived:
            process_method: load_data
            rel_path: data/processed/pancreas_processed.h5ad
    outs:
    - path: data/processed/pancreas_processed.h5ad
      md5: 7af1dfb39e8d77008a94b1c17c9c3858
      size: 424767328
  train_pancreas_model1:
    cmd: /usr/bin/time -v python train.py model_training.train=[pancreas_model1]
    deps:
    - path: data/processed/pancreas_processed.h5ad
      md5: 7af1dfb39e8d77008a94b1c17c9c3858
      size: 424767328
    - path: train.py
      md5: 0a9d3edec45ada6f48200246157d82b9
      size: 7526
    params:
      config.yaml:
        model_training.pancreas_model1:
          path: models/pancreas_model1
          model_path: models/pancreas_model1/model
          input_data_path: data/processed/pancreas_processed.h5ad
          trained_data_path: models/pancreas_model1/trained.h5ad
          pyrovelocity_data_path: models/pancreas_model1/pyrovelocity.pkl
          metrics_path: models/pancreas_model1/metrics.json
          run_info_path: models/pancreas_model1/run_info.json
          vector_field_parameters:
            basis: umap
          training_parameters:
            guide_type: auto_t0_constraint
            log_every: 100
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pancreas_model1/loss_plot.png
    outs:
    - path: models/pancreas_model1/loss_plot.png
      md5: 3231429609fc27883cbc4b7beb5be7b1
      size: 10578
    - path: models/pancreas_model1/metrics.json
      md5: cc3d1f8e0e3fa70119158cce65850e61
      size: 156
    - path: models/pancreas_model1/model
      md5: 6285eb1cd0966c9d475f2383f826c023.dir
      size: 1159231
      nfiles: 4
    - path: models/pancreas_model1/pyrovelocity.pkl
      md5: 356ba5db1c2dd67be3537777add30127
      size: 7102321859
    - path: models/pancreas_model1/run_info.json
      md5: b3ecc6302013e03d77674c476e701a66
      size: 436
    - path: models/pancreas_model1/trained.h5ad
      md5: bf05b29b0d0573ae6f5b9b4bde7a2bac
      size: 489752680
  data_download_pbmc68k:
    cmd: python data_download.py data_external.sources=[scvelo] data_external.scvelo.download=[pbmc68k]
    deps:
    - path: data_download.py
      md5: 391e26ebb263cd5e550f9365c4a7f21f
      size: 2881
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.scvelo.pbmc68k:
          data_file: pbmc68k.h5ad
          dl_root: data/PBMC
          dl_path: data/PBMC/pbmc68k.h5ad
          rel_path: data/external/pbmc68k.h5ad
          url: https://ndownloader.figshare.com/files/27686886
          derived:
            process_method: load_pbmc
            rel_path: data/processed/pbmc_processed.h5ad
    outs:
    - path: data/external/pbmc68k.h5ad
      md5: ee0953e5fb994bc3cec05d4cf638ac79
      size: 123707283
  preprocess_pbmc68k:
    cmd: python preprocess.py data_external.sources=[scvelo] data_external.scvelo.process=[pbmc68k]
    deps:
    - path: data/external/pbmc68k.h5ad
      md5: ee0953e5fb994bc3cec05d4cf638ac79
      size: 123707283
    - path: preprocess.py
      md5: 346eaf42eb0c6c729be1bfc60148787c
      size: 2451
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.scvelo.pbmc68k:
          data_file: pbmc68k.h5ad
          dl_root: data/PBMC
          dl_path: data/PBMC/pbmc68k.h5ad
          rel_path: data/external/pbmc68k.h5ad
          url: https://ndownloader.figshare.com/files/27686886
          derived:
            process_method: load_pbmc
            rel_path: data/processed/pbmc_processed.h5ad
    outs:
    - path: data/processed/pbmc_processed.h5ad
      md5: 0a1eb8cd91bdee14ea9898b284e53f5e
      size: 412368967
  train_pbmc68k_model1:
    cmd: /usr/bin/time -v python train.py model_training.train=[pbmc68k_model1]
    deps:
    - path: data/processed/pbmc_processed.h5ad
      md5: 0a1eb8cd91bdee14ea9898b284e53f5e
      size: 412368967
    - path: train.py
      md5: 0a9d3edec45ada6f48200246157d82b9
      size: 7526
    params:
      config.yaml:
        model_training.pbmc68k_model1:
          path: models/pbmc68k_model1
          model_path: models/pbmc68k_model1/model
          input_data_path: data/processed/pbmc_processed.h5ad
          trained_data_path: models/pbmc68k_model1/trained.h5ad
          pyrovelocity_data_path: models/pbmc68k_model1/pyrovelocity.pkl
          metrics_path: models/pbmc68k_model1/metrics.json
          run_info_path: models/pbmc68k_model1/run_info.json
          vector_field_parameters:
            basis: tsne
          training_parameters:
            guide_type: auto_t0_constraint
            log_every: 100
            cell_state: celltype
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pbmc68k_model1/loss_plot.png
    outs:
    - path: models/pbmc68k_model1/loss_plot.png
      md5: 1c3602f4224852da2f90c192a4db26ba
      size: 32748
    - path: models/pbmc68k_model1/metrics.json
      md5: cd3b043215e9af71ee8839ad70f9b27f
      size: 154
    - path: models/pbmc68k_model1/model
      md5: a752343d70d22ccf436c354ddfbb07e0.dir
      size: 3172240
      nfiles: 4
    - path: models/pbmc68k_model1/pyrovelocity.pkl
      md5: 13c851051ec5879b934cf5db2ebac849
      size: 262458283
    - path: models/pbmc68k_model1/run_info.json
      md5: 56552e977819aa8edc0c8102a9d0e488
      size: 435
    - path: models/pbmc68k_model1/trained.h5ad
      md5: 405bf59abbc8946ce74c87cc630cd0d3
      size: 752477435
  figure2:
    cmd: python fig2/figure.py
    deps:
    - path: fig2/figure.py
      md5: 79a6a55999a20278e14bfdb15e8fd7ae
      size: 16420
    - path: models/pancreas_model1/pyrovelocity.pkl
      md5: 356ba5db1c2dd67be3537777add30127
      size: 7102321859
    - path: models/pancreas_model1/trained.h5ad
      md5: bf05b29b0d0573ae6f5b9b4bde7a2bac
      size: 489752680
    - path: models/pbmc68k_model1/pyrovelocity.pkl
      md5: 13c851051ec5879b934cf5db2ebac849
      size: 262458283
    - path: models/pbmc68k_model1/trained.h5ad
      md5: 405bf59abbc8946ce74c87cc630cd0d3
      size: 752477435
    params:
      config.yaml:
        reports.figure2:
          tag: fig2
          path: reports/fig2
          tif_path: reports/fig2/fig2_raw_gene_selection_model1.tif
          svg_path: reports/fig2/fig2_raw_gene_selection_model1.svg
          biomarker_selection_path: reports/fig2/fig2_markers_selection_scatterplot.tif
          biomarker_phaseportrait_path: reports/fig2/fig2_markers_phaseportrait.pdf
          pancreas_model1:
            shared_time_plot: reports/fig2/fig2_pancreas_shared_time.pdf
            volcano_plot: reports/fig2/fig2_pancreas_volcano.pdf
            rainbow_plot: reports/fig2/fig2_pancreas_rainbow.pdf
            vector_field_plot: reports/fig2/fig2_pancreas_vector_field.pdf
    outs:
    - path: reports/fig2/fig2_markers_phaseportrait.pdf
      md5: a3d592ac2f7ef759923f76b63204b9df
      size: 4505593
    - path: reports/fig2/fig2_markers_selection_scatterplot.tif
      md5: 56a33ad95cda5dae2099972ebb71d646
      size: 6101990
    - path: reports/fig2/fig2_raw_gene_selection_model1.svg
      md5: e70dc2924c9c10efc8f362df6b2ce91c
      size: 49588526
    - path: reports/fig2/fig2_raw_gene_selection_model1.tif
      md5: 76cae1fa158a498a721cc566d79d2699
      size: 19360526
  plot_pancreas_model1:
    cmd: python fig2/fig2_pancreas_plot.py --config=config.yaml
    deps:
    - path: fig2/fig2_pancreas_plot.py
      md5: a17dc84c0f698f95b3d4b47cc7465af2
      size: 5830
    - path: models/pancreas_model1/pyrovelocity.pkl
      md5: 356ba5db1c2dd67be3537777add30127
      size: 7102321859
    - path: models/pancreas_model1/trained.h5ad
      md5: bf05b29b0d0573ae6f5b9b4bde7a2bac
      size: 489752680
    params:
      config.yaml:
        model_training.pancreas_model1:
          path: models/pancreas_model1
          model_path: models/pancreas_model1/model
          input_data_path: data/processed/pancreas_processed.h5ad
          trained_data_path: models/pancreas_model1/trained.h5ad
          pyrovelocity_data_path: models/pancreas_model1/pyrovelocity.pkl
          metrics_path: models/pancreas_model1/metrics.json
          run_info_path: models/pancreas_model1/run_info.json
          vector_field_parameters:
            basis: umap
          training_parameters:
            guide_type: auto_t0_constraint
            log_every: 100
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pancreas_model1/loss_plot.png
        reports.figure2.pancreas_model1:
          shared_time_plot: reports/fig2/fig2_pancreas_shared_time.pdf
          volcano_plot: reports/fig2/fig2_pancreas_volcano.pdf
          rainbow_plot: reports/fig2/fig2_pancreas_rainbow.pdf
          vector_field_plot: reports/fig2/fig2_pancreas_vector_field.pdf
    outs:
    - path: reports/fig2/fig2_pancreas_rainbow.pdf
      md5: 8acac582c5478a97b5e79492877d4482
      size: 663267
    - path: reports/fig2/fig2_pancreas_shared_time.pdf
      md5: d8b6507fbdf899ed925512eb2a9c8dbd
      size: 616498
    - path: reports/fig2/fig2_pancreas_vector_field.pdf
      md5: a4dfc5fd1e0bdb26060656df5506ccbc
      size: 408048
    - path: reports/fig2/fig2_pancreas_volcano.pdf
      md5: f9c891f9ebf718681e36632c27968f69
      size: 46350
  data_download_larry:
    cmd: python data_download.py data_external.sources=[pyrovelocity] data_external.pyrovelocity.download=[larry]
    deps:
    - path: data_download.py
      md5: 391e26ebb263cd5e550f9365c4a7f21f
      size: 2881
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.pyrovelocity.larry:
          data_file: larry.h5ad
          dl_root: data/external
          dl_path: data/external/larry.h5ad
          rel_path: data/external/larry.h5ad
          url: https://ndownloader.figshare.com/files/37028569
    outs:
    - path: data/external/larry.h5ad
      md5: d618305c0ee0e41570b1147e63df332a
      size: 1525338690
  train_pancreas_model2:
    cmd: /usr/bin/time -v python train.py model_training.train=[pancreas_model2]
    deps:
    - path: data/processed/pancreas_processed.h5ad
      md5: 7af1dfb39e8d77008a94b1c17c9c3858
      size: 424767328
    - path: train.py
      md5: 0a9d3edec45ada6f48200246157d82b9
      size: 7526
    params:
      config.yaml:
        model_training.pancreas_model2:
          path: models/pancreas_model2
          model_path: models/pancreas_model2/model
          input_data_path: data/processed/pancreas_processed.h5ad
          trained_data_path: models/pancreas_model2/trained.h5ad
          pyrovelocity_data_path: models/pancreas_model2/pyrovelocity.pkl
          metrics_path: models/pancreas_model2/metrics.json
          run_info_path: models/pancreas_model2/run_info.json
          vector_field_parameters:
            basis: umap
          training_parameters:
            guide_type: auto
            log_every: 100
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            offset: true
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pancreas_model2/loss_plot.png
    outs:
    - path: models/pancreas_model2/loss_plot.png
      md5: e78f56d442880f56b184b7b80d55d045
      size: 10525
    - path: models/pancreas_model2/metrics.json
      md5: 9630f0fad144f0afdf6ce2474c252389
      size: 154
    - path: models/pancreas_model2/model
      md5: 7e8cb4b9276784c43e182342f0d12235.dir
      size: 1735217
      nfiles: 4
    - path: models/pancreas_model2/pyrovelocity.pkl
      md5: 4d2262df7614a820a25e495d3f9fad58
      size: 6216001966
    - path: models/pancreas_model2/run_info.json
      md5: 58f3be5602557f930d14852286970695
      size: 436
    - path: models/pancreas_model2/trained.h5ad
      md5: d9711156f7b788cc9ebca6604c43a4f6
      size: 489752168
  train_pbmc68k_model2:
    cmd: /usr/bin/time -v python train.py model_training.train=[pbmc68k_model2]
    deps:
    - path: data/processed/pbmc_processed.h5ad
      md5: 0a1eb8cd91bdee14ea9898b284e53f5e
      size: 412368967
    - path: train.py
      md5: 0a9d3edec45ada6f48200246157d82b9
      size: 7526
    params:
      config.yaml:
        model_training.pbmc68k_model2:
          path: models/pbmc68k_model2
          model_path: models/pbmc68k_model2/model
          input_data_path: data/processed/pbmc_processed.h5ad
          trained_data_path: models/pbmc68k_model2/trained.h5ad
          pyrovelocity_data_path: models/pbmc68k_model2/pyrovelocity.pkl
          metrics_path: models/pbmc68k_model2/metrics.json
          run_info_path: models/pbmc68k_model2/run_info.json
          vector_field_parameters:
            basis: tsne
          training_parameters:
            guide_type: auto
            log_every: 100
            cell_state: celltype
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            offset: true
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pbmc68k_model2/loss_plot.png
    outs:
    - path: models/pbmc68k_model2/loss_plot.png
      md5: c0c8d984294b80a60964c2d6de931dc1
      size: 36691
    - path: models/pbmc68k_model2/metrics.json
      md5: 7abd87e62fe562a3cd5bb0b18a3d1178
      size: 153
    - path: models/pbmc68k_model2/model
      md5: 19337be59791cf7f38549f1ecca761c2.dir
      size: 3173124
      nfiles: 4
    - path: models/pbmc68k_model2/pyrovelocity.pkl
      md5: b61c2495511bef1617d52daead87c969
      size: 238743719
    - path: models/pbmc68k_model2/run_info.json
      md5: c926a6c336a7f3cb249e567a83c99ef9
      size: 435
    - path: models/pbmc68k_model2/trained.h5ad
      md5: 40b0525a985069fd0322a086dea17fac
      size: 752485627
  figureS3:
    cmd: python figS3/figure.py
    deps:
    - path: figS3/figure.py
      md5: 60c9ae103d128bd148c505fb92572cc3
      size: 12699
    - path: models/pancreas_model2/pyrovelocity.pkl
      md5: 4d2262df7614a820a25e495d3f9fad58
      size: 6216001966
    - path: models/pancreas_model2/trained.h5ad
      md5: d9711156f7b788cc9ebca6604c43a4f6
      size: 489752168
    - path: models/pbmc68k_model2/pyrovelocity.pkl
      md5: b61c2495511bef1617d52daead87c969
      size: 238743719
    - path: models/pbmc68k_model2/trained.h5ad
      md5: 40b0525a985069fd0322a086dea17fac
      size: 752485627
    params:
      config.yaml:
        reports.figureS3:
          tag: figS3
          path: reports/figS3
          tif_path: reports/figS3/figS3_raw_gene_selection_model2.tif
          svg_path: reports/figS3/figS3_raw_gene_selection_model2.svg
    outs:
    - path: reports/figS3/figS3_raw_gene_selection_model2.svg
      md5: 047fcd02e90cae2a999dc94acbf16228
      size: 49555237
    - path: reports/figS3/figS3_raw_gene_selection_model2.tif
      md5: 0f7f437df24735118f527ad8d6e0860a
      size: 19294478
