schema: '2.0'
stages:
  data_download_pancreas:
    cmd: python data_download.py data_external.sources=[scvelo] data_external.scvelo.download=[pancreas]
    deps:
    - path: data_download.py
      md5: 391e26ebb263cd5e550f9365c4a7f21f
      size: 2881
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.scvelo.pancreas:
          data_file: endocrinogenesis_day15.h5ad
          dl_root: data/Pancreas
          dl_path: data/Pancreas/endocrinogenesis_day15.h5ad
          rel_path: data/external/endocrinogenesis_day15.h5ad
          url: https://github.com/theislab/scvelo_notebooks/raw/master/data/Pancreas/endocrinogenesis_day15.h5ad
          derived:
            process_method: load_data
            rel_path: data/processed/pancreas_processed.h5ad
    outs:
    - path: data/external/endocrinogenesis_day15.h5ad
      md5: 783ec70c72fd895eeea28c07735efc27
      size: 52477898
  preprocess_pancreas:
    cmd: python preprocess.py data_external.sources=[scvelo] data_external.scvelo.process=[pancreas]
      +data_external.top_n=2000
    deps:
    - path: data/external/endocrinogenesis_day15.h5ad
      md5: 783ec70c72fd895eeea28c07735efc27
      size: 52477898
    - path: preprocess.py
      md5: 7dd8f92bb3193e02044baf4f5ccc1e71
      size: 2748
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.scvelo.pancreas:
          data_file: endocrinogenesis_day15.h5ad
          dl_root: data/Pancreas
          dl_path: data/Pancreas/endocrinogenesis_day15.h5ad
          rel_path: data/external/endocrinogenesis_day15.h5ad
          url: https://github.com/theislab/scvelo_notebooks/raw/master/data/Pancreas/endocrinogenesis_day15.h5ad
          derived:
            process_method: load_data
            rel_path: data/processed/pancreas_processed.h5ad
    outs:
    - path: data/processed/pancreas_processed.h5ad
      md5: 7af1dfb39e8d77008a94b1c17c9c3858
      size: 424767328
  train_pancreas_model1:
    cmd: python train.py model_training.train=[pancreas_model1]
    deps:
    - path: data/processed/pancreas_processed.h5ad
      md5: 7af1dfb39e8d77008a94b1c17c9c3858
      size: 424767328
    - path: train.py
      md5: 0a9d3edec45ada6f48200246157d82b9
      size: 7526
    params:
      config.yaml:
        model_training.pancreas_model1:
          path: models/pancreas_model1
          model_path: models/pancreas_model1/model
          input_data_path: data/processed/pancreas_processed.h5ad
          trained_data_path: models/pancreas_model1/trained.h5ad
          pyrovelocity_data_path: models/pancreas_model1/pyrovelocity.pkl
          metrics_path: models/pancreas_model1/metrics.json
          run_info_path: models/pancreas_model1/run_info.json
          vector_field_parameters:
            basis: umap
          training_parameters:
            guide_type: auto_t0_constraint
            log_every: 100
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pancreas_model1/loss_plot.png
    outs:
    - path: models/pancreas_model1/metrics.json
      md5: e3871fabe05b83cbd7edc86995726ec5
      size: 159
    - path: models/pancreas_model1/model
      md5: b8cad727506cc41d1e7fc83cc881808f.dir
      size: 1159443
      nfiles: 4
    - path: models/pancreas_model1/pyrovelocity.pkl
      md5: be84ba0bda845db65756dca4ee5ee301
      size: 7102321859
    - path: models/pancreas_model1/run_info.json
      md5: 1ace1fec6cf4875490fdd8245eb8a7bc
      size: 455
    - path: models/pancreas_model1/trained.h5ad
      md5: 838ab1051c5d50a08c23a01766f3b4db
      size: 489752680
  data_download_pbmc68k:
    cmd: python data_download.py data_external.sources=[scvelo] data_external.scvelo.download=[pbmc68k]
    deps:
    - path: data_download.py
      md5: 391e26ebb263cd5e550f9365c4a7f21f
      size: 2881
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.scvelo.pbmc68k:
          data_file: pbmc68k.h5ad
          dl_root: data/PBMC
          dl_path: data/PBMC/pbmc68k.h5ad
          rel_path: data/external/pbmc68k.h5ad
          url: https://ndownloader.figshare.com/files/27686886
          derived:
            process_method: load_pbmc
            rel_path: data/processed/pbmc_processed.h5ad
            rel_path_2000genes: data/processed/pbmc_processed_2000genes.h5ad
    outs:
    - path: data/external/pbmc68k.h5ad
      md5: ee0953e5fb994bc3cec05d4cf638ac79
      size: 123707283
  preprocess_pbmc68k:
    cmd: python preprocess.py data_external.sources=[scvelo] data_external.scvelo.process=[pbmc68k]
      +data_external.top_n=3
    deps:
    - path: data/external/pbmc68k.h5ad
      md5: ee0953e5fb994bc3cec05d4cf638ac79
      size: 123707283
    - path: preprocess.py
      md5: 7dd8f92bb3193e02044baf4f5ccc1e71
      size: 2748
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.scvelo.pbmc68k:
          data_file: pbmc68k.h5ad
          dl_root: data/PBMC
          dl_path: data/PBMC/pbmc68k.h5ad
          rel_path: data/external/pbmc68k.h5ad
          url: https://ndownloader.figshare.com/files/27686886
          derived:
            process_method: load_pbmc
            rel_path: data/processed/pbmc_processed.h5ad
            rel_path_2000genes: data/processed/pbmc_processed_2000genes.h5ad
    outs:
    - path: data/processed/pbmc_processed.h5ad
      md5: 1b5cea59014f2232e75531041b45c132
      size: 412452935
  train_pbmc68k_model1:
    cmd: python train.py model_training.train=[pbmc68k_model1]
    deps:
    - path: data/processed/pbmc_processed.h5ad
      md5: 1b5cea59014f2232e75531041b45c132
      size: 412452935
    - path: train.py
      md5: 0a9d3edec45ada6f48200246157d82b9
      size: 7526
    params:
      config.yaml:
        model_training.pbmc68k_model1:
          path: models/pbmc68k_model1
          model_path: models/pbmc68k_model1/model
          input_data_path: data/processed/pbmc_processed.h5ad
          trained_data_path: models/pbmc68k_model1/trained.h5ad
          pyrovelocity_data_path: models/pbmc68k_model1/pyrovelocity.pkl
          metrics_path: models/pbmc68k_model1/metrics.json
          run_info_path: models/pbmc68k_model1/run_info.json
          vector_field_parameters:
            basis: tsne
          training_parameters:
            guide_type: auto_t0_constraint
            log_every: 100
            cell_state: celltype
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pbmc68k_model1/loss_plot.png
    outs:
    - path: models/pbmc68k_model1/model
      md5: ae801728bcd080f8798d3c8e1bddf38f.dir
      size: 3172516
      nfiles: 4
    - path: models/pbmc68k_model1/pyrovelocity.pkl
      md5: 522dde358d227e3f2a5096dde5450a48
      size: 262458283
    - path: models/pbmc68k_model1/trained.h5ad
      md5: 1b885300adc01533bf7abf1c547e93c8
      size: 752585979
  figure2:
    cmd: python fig2/figure.py
    deps:
    - path: fig2/figure.py
      md5: e98a8269c69e429f5816a56619f29916
      size: 16278
    - path: models/pancreas_model1/pyrovelocity.pkl
      md5: be84ba0bda845db65756dca4ee5ee301
      size: 7102321859
    - path: models/pancreas_model1/trained.h5ad
      md5: 838ab1051c5d50a08c23a01766f3b4db
      size: 489752680
    - path: models/pbmc68k_model1/pyrovelocity.pkl
      md5: 522dde358d227e3f2a5096dde5450a48
      size: 262458283
    - path: models/pbmc68k_model1/trained.h5ad
      md5: 1b885300adc01533bf7abf1c547e93c8
      size: 752585979
    params:
      config.yaml:
        reports.figure2:
          tag: fig2
          path: reports/fig2
          tif_path: reports/fig2/fig2_raw_gene_selection_model1.tif
          svg_path: reports/fig2/fig2_raw_gene_selection_model1.svg
          biomarker_selection_path: reports/fig2/fig2_markers_selection_scatterplot.tif
          biomarker_phaseportrait_path: reports/fig2/fig2_markers_phaseportrait.pdf
          pancreas_model1:
            shared_time_plot: reports/fig2/fig2_pancreas_shared_time.pdf
            volcano_plot: reports/fig2/fig2_pancreas_volcano.pdf
            rainbow_plot: reports/fig2/fig2_pancreas_rainbow.pdf
            vector_field_plot: reports/fig2/fig2_pancreas_vector_field.pdf
    outs:
    - path: reports/fig2/fig2_markers_phaseportrait.pdf
      md5: 49e18ae88962335726acdecb09a5b3c6
      size: 4520121
    - path: reports/fig2/fig2_markers_selection_scatterplot.tif
      md5: aef1cd0a2957d475e370ca3c3f9846af
      size: 6101990
    - path: reports/fig2/fig2_raw_gene_selection_model1.svg
      md5: f7a87c28a7f39a5037af3ccadcc2f2bb
      size: 49654489
    - path: reports/fig2/fig2_raw_gene_selection_model1.tif
      md5: 3dd516ed15f814dc2daf67e4d191d6e3
      size: 19360526
  plot_pancreas_model1:
    cmd: python fig2/fig2_pancreas_plot.py --config=config.yaml
    deps:
    - path: fig2/fig2_pancreas_plot.py
      md5: a17dc84c0f698f95b3d4b47cc7465af2
      size: 5830
    - path: models/pancreas_model1/pyrovelocity.pkl
      md5: be84ba0bda845db65756dca4ee5ee301
      size: 7102321859
    - path: models/pancreas_model1/trained.h5ad
      md5: 838ab1051c5d50a08c23a01766f3b4db
      size: 489752680
    params:
      config.yaml:
        model_training.pancreas_model1:
          path: models/pancreas_model1
          model_path: models/pancreas_model1/model
          input_data_path: data/processed/pancreas_processed.h5ad
          trained_data_path: models/pancreas_model1/trained.h5ad
          pyrovelocity_data_path: models/pancreas_model1/pyrovelocity.pkl
          metrics_path: models/pancreas_model1/metrics.json
          run_info_path: models/pancreas_model1/run_info.json
          vector_field_parameters:
            basis: umap
          training_parameters:
            guide_type: auto_t0_constraint
            log_every: 100
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pancreas_model1/loss_plot.png
        reports.figure2.pancreas_model1:
          shared_time_plot: reports/fig2/fig2_pancreas_shared_time.pdf
          volcano_plot: reports/fig2/fig2_pancreas_volcano.pdf
          rainbow_plot: reports/fig2/fig2_pancreas_rainbow.pdf
          vector_field_plot: reports/fig2/fig2_pancreas_vector_field.pdf
    outs:
    - path: reports/fig2/fig2_pancreas_rainbow.pdf
      md5: 88831024cfac369ee6e8c4432d09f9df
      size: 663371
    - path: reports/fig2/fig2_pancreas_shared_time.pdf
      md5: 69255e5f41769f8e40d5bc9e57522559
      size: 616839
    - path: reports/fig2/fig2_pancreas_vector_field.pdf
      md5: 00f91a2f977580f4f9108b9f71e853b0
      size: 408002
    - path: reports/fig2/fig2_pancreas_volcano.pdf
      md5: a8e46ad1bea4a1d053d0b6676ab55b11
      size: 46340
  data_download_larry:
    cmd: python data_download.py data_external.sources=[pyrovelocity] data_external.pyrovelocity.download=[larry]
    deps:
    - path: data_download.py
      md5: 391e26ebb263cd5e550f9365c4a7f21f
      size: 2881
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.pyrovelocity.larry:
          data_file: larry.h5ad
          dl_root: data/external
          dl_path: data/external/larry.h5ad
          rel_path: data/external/larry.h5ad
          url: https://ndownloader.figshare.com/files/37028569
    outs:
    - path: data/external/larry.h5ad
      md5: d618305c0ee0e41570b1147e63df332a
      size: 1525338690
  train_pancreas_model2:
    cmd: python train.py model_training.train=[pancreas_model2]
    deps:
    - path: data/processed/pancreas_processed.h5ad
      md5: 7af1dfb39e8d77008a94b1c17c9c3858
      size: 424767328
    - path: train.py
      md5: 0a9d3edec45ada6f48200246157d82b9
      size: 7526
    params:
      config.yaml:
        model_training.pancreas_model2:
          path: models/pancreas_model2
          model_path: models/pancreas_model2/model
          input_data_path: data/processed/pancreas_processed.h5ad
          trained_data_path: models/pancreas_model2/trained.h5ad
          pyrovelocity_data_path: models/pancreas_model2/pyrovelocity.pkl
          metrics_path: models/pancreas_model2/metrics.json
          run_info_path: models/pancreas_model2/run_info.json
          vector_field_parameters:
            basis: umap
          training_parameters:
            guide_type: auto
            log_every: 100
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            offset: true
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pancreas_model2/loss_plot.png
    outs:
    - path: models/pancreas_model2/metrics.json
      md5: 69984a822a134a34ebbbd27ac79b782f
      size: 158
    - path: models/pancreas_model2/model
      md5: 77a371d71ff090e0e9839084473945b4.dir
      size: 1735429
      nfiles: 4
    - path: models/pancreas_model2/pyrovelocity.pkl
      md5: d03b8a0048ba078b87785de38ed9dea4
      size: 6216001966
    - path: models/pancreas_model2/run_info.json
      md5: c382513c8bd5ca180c9b1080c111c140
      size: 455
    - path: models/pancreas_model2/trained.h5ad
      md5: 09d3e6f0c43b8ff97fea1104e61fe4b5
      size: 489752680
  train_pbmc68k_model2:
    cmd: python train.py model_training.train=[pbmc68k_model2]
    deps:
    - path: data/processed/pbmc_processed.h5ad
      md5: 1b5cea59014f2232e75531041b45c132
      size: 412452935
    - path: train.py
      md5: 0a9d3edec45ada6f48200246157d82b9
      size: 7526
    params:
      config.yaml:
        model_training.pbmc68k_model2:
          path: models/pbmc68k_model2
          model_path: models/pbmc68k_model2/model
          input_data_path: data/processed/pbmc_processed.h5ad
          trained_data_path: models/pbmc68k_model2/trained.h5ad
          pyrovelocity_data_path: models/pbmc68k_model2/pyrovelocity.pkl
          metrics_path: models/pbmc68k_model2/metrics.json
          run_info_path: models/pbmc68k_model2/run_info.json
          vector_field_parameters:
            basis: tsne
          training_parameters:
            guide_type: auto
            log_every: 100
            cell_state: celltype
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            offset: true
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pbmc68k_model2/loss_plot.png
    outs:
    - path: models/pbmc68k_model2/model
      md5: b14b0a52c189378d0fcc1007414abe8d.dir
      size: 3173270
      nfiles: 4
    - path: models/pbmc68k_model2/pyrovelocity.pkl
      md5: dcb1a28c3132665531a14ad406291005
      size: 238743719
    - path: models/pbmc68k_model2/trained.h5ad
      md5: 97166108d119f021aac3c11d2ee666f3
      size: 752661435
  figureS3:
    cmd: python figS3/figure.py
    deps:
    - path: figS3/figure.py
      md5: 60c9ae103d128bd148c505fb92572cc3
      size: 12699
    - path: models/pancreas_model2/pyrovelocity.pkl
      md5: d03b8a0048ba078b87785de38ed9dea4
      size: 6216001966
    - path: models/pancreas_model2/trained.h5ad
      md5: 09d3e6f0c43b8ff97fea1104e61fe4b5
      size: 489752680
    - path: models/pbmc68k_model2/pyrovelocity.pkl
      md5: dcb1a28c3132665531a14ad406291005
      size: 238743719
    - path: models/pbmc68k_model2/trained.h5ad
      md5: 97166108d119f021aac3c11d2ee666f3
      size: 752661435
    params:
      config.yaml:
        reports.figureS3:
          tag: figS3
          path: reports/figS3
          tif_path: reports/figS3/figS3_raw_gene_selection_model2.tif
          svg_path: reports/figS3/figS3_raw_gene_selection_model2.svg
    outs:
    - path: reports/figS3/figS3_raw_gene_selection_model2.svg
      md5: 49959b687ab825b3e7f4f4d8487fa88e
      size: 49712655
    - path: reports/figS3/figS3_raw_gene_selection_model2.tif
      md5: f883bdc9a651704e06b284db3b554a59
      size: 19294478
  preprocess_pbmc68k_2000genes:
    cmd: python preprocess.py data_external.sources=[scvelo] data_external.scvelo.process=[pbmc68k]
      +data_external.top_n=2000
    deps:
    - path: data/external/pbmc68k.h5ad
      md5: ee0953e5fb994bc3cec05d4cf638ac79
      size: 123707283
    - path: preprocess.py
      md5: 7dd8f92bb3193e02044baf4f5ccc1e71
      size: 2748
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.scvelo.pbmc68k:
          data_file: pbmc68k.h5ad
          dl_root: data/PBMC
          dl_path: data/PBMC/pbmc68k.h5ad
          rel_path: data/external/pbmc68k.h5ad
          url: https://ndownloader.figshare.com/files/27686886
          derived:
            process_method: load_pbmc
            rel_path: data/processed/pbmc_processed.h5ad
            rel_path_2000genes: data/processed/pbmc_processed_2000genes.h5ad
    outs:
    - path: data/processed/pbmc_processed_2000genes.h5ad
      md5: 400818aca31c34496e5dfb61d7428a87
      size: 1673903198
  train_pbmc68k_model2_2000genes:
    cmd: python train.py model_training.train=[pbmc68k_model2_2000genes]
    deps:
    - path: data/processed/pbmc_processed_2000genes.h5ad
      md5: 400818aca31c34496e5dfb61d7428a87
      size: 1673903198
    - path: train.py
      md5: 0a9d3edec45ada6f48200246157d82b9
      size: 7526
    params:
      config.yaml:
        model_training.pbmc68k_model2_2000genes:
          path: models/pbmc68k_model2
          model_path: models/pbmc68k_model2/model_2000genes
          input_data_path: data/processed/pbmc_processed_2000genes.h5ad
          trained_data_path: models/pbmc68k_model2/trained_2000genes.h5ad
          pyrovelocity_data_path: models/pbmc68k_model2/pyrovelocity_2000genes.pkl
          metrics_path: models/pbmc68k_model2/2000genes_metrics.json
          run_info_path: models/pbmc68k_model2/2000genes_run_info.json
          vector_field_parameters:
            basis: tsne
          training_parameters:
            guide_type: auto
            log_every: 100
            cell_state: celltype
            patient_improve: 0.0001
            patient_init: 45
            max_epochs: 4000
            offset: true
            lr: 0.01
            train_size: 1.0
            loss_plot_path: models/pbmc68k_model2/2000genes_loss_plot.png
    outs:
    - path: models/pbmc68k_model2/model_2000genes
      md5: 78b5efac5b27c910064ed563ae8c3a4a.dir
      size: 3510779
      nfiles: 4
    - path: models/pbmc68k_model2/pyrovelocity_2000genes.pkl
      md5: 80d9249bccc8b5d4524d64bc0b6ec6b2
      size: 24366111782
    - path: models/pbmc68k_model2/trained_2000genes.h5ad
      md5: 2f98b3c100ecf844a744d37a8f6ad57b
      size: 2243815621
