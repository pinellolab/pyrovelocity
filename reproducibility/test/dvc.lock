schema: '2.0'
stages:
  data_download_simulate:
    cmd: python data_download.py data_external.sources=[simulate] data_external.simulate.download=[medium]
    deps:
    - path: data_download.py
      md5: 30f38cc794cbf4caad2675ffd88c2467
      size: 3305
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.simulate.medium:
          data_file: simulated_medium.h5ad
          dl_root: data/external
          dl_path: data/external/simulated_medium.h5ad
          rel_path: data/external/simulated_medium.h5ad
          url: https://storage.googleapis.com/pyrovelocity/data/simulated_medium.h5ad
          derived:
            process_method: load_data
            process_args: {}
            rel_path: data/processed/simulated_medium_processed.h5ad
    outs:
    - path: data/external/simulated_medium.h5ad
      md5: c8483b84bd68f57acb407f715f807f9e
      size: 60248568
  preprocess_simulate:
    cmd: python preprocess.py data_external.sources=[simulate] data_external.simulate.process=[medium]
    deps:
    - path: data/external/simulated_medium.h5ad
      md5: c8483b84bd68f57acb407f715f807f9e
      size: 60248568
    - path: preprocess.py
      md5: bf09c86fc25b1d1a98b9aa1c5fa04361
      size: 2757
    params:
      config.yaml:
        base:
          log_level: INFO
        data_external.simulate.medium:
          data_file: simulated_medium.h5ad
          dl_root: data/external
          dl_path: data/external/simulated_medium.h5ad
          rel_path: data/external/simulated_medium.h5ad
          url: https://storage.googleapis.com/pyrovelocity/data/simulated_medium.h5ad
          derived:
            process_method: load_data
            process_args: {}
            rel_path: data/processed/simulated_medium_processed.h5ad
    outs:
    - path: data/processed/simulated_medium_processed.h5ad
      md5: 9deb095966ca13078b3927d75cd618c4
      size: 257351704
  train_simulate_model2:
    cmd: /usr/bin/time -v python train.py model_training.train=[simulate_model2]
    deps:
    - path: data/processed/simulated_medium_processed.h5ad
      md5: 9deb095966ca13078b3927d75cd618c4
      size: 257351704
    - path: train.py
      md5: cf54fc20b2c14a7cabee7eb472667183
      size: 8722
    params:
      config.yaml:
        model_training.simulate_model2:
          path: models/medium_model2
          model_path: models/medium_model2/model
          input_data_path: data/processed/simulated_medium_processed.h5ad
          trained_data_path: models/medium_model2/trained.h5ad
          pyrovelocity_data_path: models/medium_model2/pyrovelocity.pkl
          metrics_path: models/medium_model2/metrics.json
          run_info_path: models/medium_model2/run_info.json
          vector_field_parameters:
            basis: umap
          training_parameters:
            _target_: pyrovelocity.api.train_model
            _partial_: true
            guide_type: auto
            model_type: auto
            svi_train: false
            batch_size: -1
            train_size: 1.0
            use_gpu: 0
            likelihood: Poisson
            num_samples: 30
            log_every: 100
            cell_state: leiden
            patient_improve: 0.0001
            patient_init: 45
            seed: 99
            lr: 0.01
            max_epochs: 1000
            include_prior: true
            library_size: true
            offset: true
            input_type: raw
            cell_specific_kinetics:
            kinetics_num: 2
            loss_plot_path: models/medium_model2/loss_plot.png
    outs:
    - path: models/medium_model2/loss_plot.png
      md5: d6bdd611ee6fd5f8796193649e4ea320
      size: 11253
    - path: models/medium_model2/metrics.json
      md5: 70299a2625ea534a1f7bf262385e5f83
      size: 157
    - path: models/medium_model2/model
      md5: a79504357ab75bbeaff41058368c0a4a.dir
      size: 487274
      nfiles: 1
    - path: models/medium_model2/pyrovelocity.pkl
      md5: fa60f4e26d085fc677254b0a71be24e6
      size: 48113640
    - path: models/medium_model2/run_info.json
      md5: 080dd41efdd040f8c744d1368b223644
      size: 452
    - path: models/medium_model2/trained.h5ad
      md5: 1d4beaf55d43cff1cb4336daa91e9cd3
      size: 283925496
  summarize_simulate_model2:
    cmd: python summarize.py reports.model_summary.summarize=[simulate_model2]
    deps:
    - path: models/medium_model2/pyrovelocity.pkl
      md5: fa60f4e26d085fc677254b0a71be24e6
      size: 48113640
    - path: models/medium_model2/trained.h5ad
      md5: 1d4beaf55d43cff1cb4336daa91e9cd3
      size: 283925496
    - path: summarize.py
      md5: fc788b41a7fe161e68319b6bc7a55a50
      size: 9584
    params:
      config.yaml:
        model_training.simulate_model2:
          path: models/medium_model2
          model_path: models/medium_model2/model
          input_data_path: data/processed/simulated_medium_processed.h5ad
          trained_data_path: models/medium_model2/trained.h5ad
          pyrovelocity_data_path: models/medium_model2/pyrovelocity.pkl
          metrics_path: models/medium_model2/metrics.json
          run_info_path: models/medium_model2/run_info.json
          vector_field_parameters:
            basis: umap
          training_parameters:
            _target_: pyrovelocity.api.train_model
            _partial_: true
            guide_type: auto
            model_type: auto
            svi_train: false
            batch_size: -1
            train_size: 1.0
            use_gpu: 0
            likelihood: Poisson
            num_samples: 30
            log_every: 100
            cell_state: leiden
            patient_improve: 0.0001
            patient_init: 45
            seed: 99
            lr: 0.01
            max_epochs: 1000
            include_prior: true
            library_size: true
            offset: true
            input_type: raw
            cell_specific_kinetics:
            kinetics_num: 2
            loss_plot_path: models/medium_model2/loss_plot.png
        reports.model_summary.simulate_model2:
          path: reports/medium_model2
          dataframe_path: data/processed/medium_model2_dataframe.pkl.zst
          shared_time_plot: reports/medium_model2/shared_time.pdf
          volcano_plot: reports/medium_model2/volcano.pdf
          rainbow_plot: reports/medium_model2/rainbow.pdf
          uncertainty_param_plot: reports/medium_model2/param_uncertainties.pdf
          vector_field_plot: reports/medium_model2/vector_field.pdf
          biomarker_selection_plot: reports/medium_model2/markers_selection_scatterplot.tif
          biomarker_phaseportrait_plot: reports/medium_model2/markers_phaseportrait.pdf
    outs:
    - path: data/processed/medium_model2_dataframe.pkl.zst
      md5: 12e544a30c6d793d04f0a48245d309c8
      size: 5068789
    - path: reports/medium_model2/rainbow.pdf
      md5: cf135ce3f921545c84e5d4e7640981c6
      size: 406702
    - path: reports/medium_model2/rainbow.pdf.png
      md5: 500c1477efe92268ba2d7192374af48a
      size: 888996
    - path: reports/medium_model2/shared_time.pdf
      md5: 4c23a815d83c219088301196b03a2263
      size: 209284
    - path: reports/medium_model2/vector_field.pdf
      md5: 0deb1a2fa1e9c7cf42260c6154c517c9
      size: 204747
    - path: reports/medium_model2/vector_field.pdf.png
      md5: 7fda792abe9a18d1a2c342d24147291c
      size: 511930
    - path: reports/medium_model2/volcano.pdf
      md5: 6987450a062ae97379bfbfc5d391d122
      size: 20419
